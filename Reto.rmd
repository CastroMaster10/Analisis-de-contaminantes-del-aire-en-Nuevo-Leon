---
title: "Tecnológico de Monterrey"
date: "1 de Septiembre de 2023"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


**Aplicación de métodos multivariados en ciencia de datos**

MA2003B.101

# **Conocimiento de la naturaleza de contaminantes que influyen en la calidad del aire y sus interrelaciones con el medio**

**Profesoras**

### Monica Guadalupe Elizondo Amaya

### Blanca Rosa Ruiz Hernandez

**Autores**

**(Equipo 6)**

Rubén Darío Castro Terrazas (A00833945)

Christian Jaffe Alarcón Acosta (A00832881)

José Andrés Orantes Guillén (A01174130)

Juan José Montes Raygoza (A00834630)

Pedro Fernández Merino (A01733006)

# Importar librerias y dependencias

```{r warning =FALSE,echo=FALSE}
library(readxl)
library(Hmisc)
library(gridExtra)
library(ggplot2)
library(corrplot)
library(dplyr)
library(outliers)
library(zoo)
library(MASS)
library(psych)
library(stats)
library(factoextra)
library(FactoMineR)
library(rgl)
```


# Etapa I

La problemática de la contaminación del aire se ha erigido como un tema de suma importancia en la agenda global, debido a sus profundos impactos en la salud humana, el entorno ambiental y el fenómeno del cambio climático. La calidad del aire se refiere a la composición y pureza de los gases que conforman la atmósfera que respiramos. Esta contaminación puede originarse de diversas fuentes, tales como la quema de combustibles fósiles, las emisiones industriales, el tráfico vehicular y las prácticas agrícolas. En el contexto específico de Nuevo León y su zona metropolitana, estas cuatro actividades ejercen un notorio impacto.

A medida que estas fuentes emiten contaminantes al aire, sus efectos pueden acarrear consecuencias graves para la sociedad y el planeta en su conjunto. De acuerdo con la Organización Mundial de la Salud, la contaminación del aire representa uno de los principales riesgos ambientales para la salud, desencadenando una carga significativa de enfermedades como accidentes cerebrovasculares, enfermedades cardíacas, cáncer de pulmón y diversas afecciones pulmonares crónicas y agudas, incluyendo el asma. De hecho, estas enfermedades se asocian con un número anual alarmante de 6.7 millones de muertes prematuras [1].

Por otra parte, estadísticas proporcionadas por la National Weather Service han calculado que los costos económicos relacionados con esta contaminación ascienden a 150 mil millones de dólares anuales, únicamente en los Estados Unidos [2]. De esta manera, resulta claro que por el bienestar de la economía y, lo que es aún más primordial, por la preservación de nuestra salud, se torna imperativo salvaguardar la calidad del aire que nos rodea.

Es fundamental comprender los aspectos cruciales que se consideran al analizar la calidad del aire y familiarizarse con las clasificaciones internacionales de los contaminantes más relevantes, así como identificar los contaminantes más perjudiciales para la salud. Esta información enriquecerá considerablemente el contenido de este informe. Entre los aspectos esenciales para evaluar la calidad del aire se destacan:

§**Partículas en suspensión (PM2.5 y PM10):** Estas partículas diminutas suspendidas en el aire tienen un impacto significativo en la salud. Las PM2.5 son aquellas con un diámetro igual o menor a 2.5 micrómetros, mientras que las PM10 tienen un diámetro igual o menor a 10 micrómetros [3].

§**Niveles elevados de ozono (O3):** Cuando el ozono, un compuesto que nos protege de los rayos ultravioleta en la estratósfera, desciende a niveles del suelo, provoca contaminación atmosférica perjudicial, conocida como "smog" en inglés. Esto tiene consecuencias negativas para la salud comunitaria [4].

§ **Dióxido de nitrógeno:** Este gas contribuye a la formación del "smog" y está relacionado con problemas de salud como afecciones respiratorias.

§ **Dióxido de azufre:** Principalmente emitido por la quema de combustibles fósiles, este compuesto puede dar lugar a la lluvia ácida y otros impactos ambientales [5].

§ **Plomo:** El plomo representa una preocupación mayor debido a sus graves efectos en la salud y desarrollo humano. Estudios, como los citados en un artículo de The Atlantic, han demostrado una relación directa entre la exposición al plomo y la disminución del coeficiente intelectual, daños auditivos, habilidades cognitivas debilitadas e incluso tasas más altas de criminalidad en diferentes estados [6]. En el siglo XX, el plomo desempeñó un papel determinante en el deterioro del desarrollo infantil en Estados Unidos, lo que resalta su impacto negativo en la sociedad.

Es crucial comprender cómo se mide la calidad del aire, qué variables intervienen en este proceso y cómo se llevan a cabo las mediciones. Para llevar a cabo la medición de la calidad del aire, se emplean sistemas de vigilancia equipados con sensores diseñados específicamente para detectar contaminantes particulares. Estos contaminantes pueden originarse tanto de fuentes naturales, como tormentas de polvo, humo de incendios forestales y erupciones volcánicas, como de fuentes antropogénicas, como la quema de combustibles fósiles [7].

Dentro del conjunto de contaminantes mencionados previamente, existen algunos que tienen impactos significativos en la salud humana y el medio ambiente. Entre estos se encuentran PM2.5, PM10, ozono troposférico, dióxido de carbono, dióxido de nitrógeno y dióxido de azufre [8]. La presencia y concentración de estos contaminantes en el aire se traducen en el Índice de Calidad del Aire (ICA), cuyo rango va desde 0 hasta 500. En este índice, un puntaje de 50 o menos se considera seguro, mientras que valores superiores a 100 indican niveles poco saludables [9]

Sin embargo, la evaluación de la calidad del aire no se limita únicamente a los contaminantes presentes en el aire en un momento determinado. Las estaciones meteorológicas también incorporan variables como la dirección y velocidad del viento, la humedad relativa, la temperatura, la precipitación, la presión atmosférica y la radiación solar en su análisis. Estos factores meteorológicos juegan un papel crucial en la dispersión y concentración de los contaminantes, así como en la formación de patrones de contaminación.

Esta comprensión integral de la medición de la calidad del aire nos brinda una perspectiva más completa sobre cómo se evalúa y monitorea esta cuestión crítica, en concordancia con la información previamente proporcionada.

§ **Cuáles son las normas oficiales establecidas de los distintos contaminantes para la protección de la salud.**

Las normas oficiales establecidas de los contaminantes para la protección de la salud son las siguientes:


| **Contaminante**|-| **Norma** | **Concentración** | **Tiempo de exposición(horas)** |
| --- | --- | --- | --- | --- |
| Monóxido de Carbono | CO | NOM-021-SSAI-2021 | 26.00 ppm | 1 |
| Monóxido de Carbono | CO | NOM-021-SSAI-2021 | 9.0 ppm | 8 |
| Bióxido de Azufre | SO2 | NOM-022-SSAI-2019 | 0.075 ppm | 1 |
| Bióxido de Azufre | SO2 | NOM-022-SSAI-2019 | 0.04 ppm | 24 |
| Ozono | O3 | NOM-020-SSAI-2021 | 0.090 ppm | 1 |
| Ozono | O3 | NOM-020-SSAI-2021 | 0.065 ppm | 8 |
| Bióxido de Nitrógeno | NO2 | NOM-023-SSAI-2021 | 0.106 ppm | 1 |
| Bióxido de Nitrógeno | NO2 | NOM-023-SSAI-2021 | 0.021 ppm | Promedio Anual |
| Partículas Menores a 10 micras | PM10 | NOM-025-SSAI-2021 | 70 µg/m3 | 24 |
| Partículas Menores a 10 micras | PM10 | NOM-025-SSAI-2021 | 36 µg/m3 | Promedio Anual |
| Partículas Menores a 2.5 micras | PM2.5 | NOM-025-SSAI-2021 | 41 µg/m3 | 24 |
| Partículas Menores a 2.5 micras | PM2.5 | NOM-025-SSAI-2021 | 10 µg/m3 | Promedio Anual |

**Tabla 1. Normas Oficiales, obtenida de: Aire Nuevo León**

En estas normas se establecen los criterios a tomar en cuenta para evaluar la calidad del aire, con respecto a la concentración de cada contaminante.

La medición de la calidad del aire se encuentra confrontada con desafíos considerables debido a una serie de factores complejos. La falta de estandarización en los métodos de medición, la variabilidad en distintos lugares y momentos, y la complejidad inherente de los contaminantes y sus impactos en la salud humana se perfilan como obstáculos centrales [10].

La falta de uniformidad en los enfoques de medición dificulta la comparación y evaluación de datos, lo que a su vez complica la toma de decisiones informadas. La variabilidad en la calidad del aire, impulsada por diversas fuentes de contaminación, condiciones climáticas cambiantes y características topográficas, plantea dificultades para obtener mediciones verdaderamente precisas. Además, la amplia gama de contaminantes y sus efectos multifacéticos en la salud requieren la implementación de equipos y metodologías especializadas [10].

Un factor adicional que contribuye a los desafíos es la falta de requisitos legales para la medición de la calidad del aire en un considerable 37% de los países, según datos del Programa de las Naciones Unidas para el Medio Ambiente (PNUMA). Esta carencia limita la disponibilidad de datos confiables y obstaculiza la formulación de políticas efectivas para controlar la contaminación del aire y salvaguardar la salud pública [11]. En resumen, la superación de estas dificultades es de vital importancia para comprender plenamente y mitigar los riesgos asociados con la contaminación del aire.

**Socio Formador**

En México, se han establecido los programas ProAire para abordar las necesidades de los estados en cuanto a contar con herramientas preventivas y correctivas en relación con la calidad del aire y la protección de la salud [12]. Un ejemplo de ello es el programa SIMA en el Estado de Nuevo León, que representa el Sistema Integral de Monitoreo Ambiental. En este proyecto, SIMA desempeña un papel fundamental como socio formador en el proyecto actual, trabajando conjuntamente para lograr los objetivos que se describen a continuación.

El programa SIMA es una iniciativa respaldada por el Gobierno del Estado de Nuevo León, cuyo propósito central radica en evaluar la calidad del aire mediante la monitorización de las concentraciones atmosféricas a las que está expuesta la población. Específicamente, en situaciones adversas, el programa tiene la función de alertar a la población sobre episodios en los que los niveles de contaminación atmosférica son elevados [13].

Una de las características destacadas de este programa es su capacidad para suministrar información actualizada de manera constante acerca de la calidad del aire en la región donde opera. Su ámbito de actuación principal abarca la zona metropolitana de Monterrey. La entidad responsable de la gestión de este programa es la Secretaría de Medio Ambiente.

·**Descripción del problema específico (preguntas de investigación)**

El problema es la contaminación del aire producida por diferentes contaminantes en el estado de Nuevo León y diferentes cuestiones climatológicas, por eso se abordarán las siguientes preguntas de investigación para enfocarnos en el problema específico:

- ¿Hay una relación entre los contaminantes que tenga un impacto significativo en la calidad del aire?
- ¿La calidad del aire se ve afectada por una relación entre las cuestiones climatológicas y los contaminantes?
- ¿Qué tanto se ve afectada la calidad del aire con relación a la concentración de cada contaminante?

·**Objetivos (se definen con base en las preguntas de investigación)**

**Pregunta 1:**

1. **Objetivo General:** Identificar si existen relaciones entre los contaminantes atmosféricos que se encuentran en la base de datos y a su vez determinar si estas relaciones tienen un impacto importante en la calidad del aire.
2. **Objetivos Específicos:**
  1. Analizar el impacto de cada contaminante en la calidad del aire.
  2. Identificar patrones de comportamiento temporales en los contaminantes y su impacto en la calidad del aire.
  3. Comparar el impacto de los contaminantes en la calidad del aire.

**Pregunta 2:**

1. **Objetivo General:** Observar la relación entre las variables climatológicas y las variables contaminantes para determinar el impacto de esta relación en la calidad del aire.
2. **Objetivos Específicos:**
  1. Analizar el impacto de las variables climatológicas en la calidad del aire.
  2. Realizar el análisis de la relación entre las variables climatológicas y las contaminantes.
  3. Evaluar de qué forma varía el impacto de las variables climatológicas y contaminantes en la calidad del aire, debido a la variación geográfica.
  4. Identificar patrones de comportamiento temporales en la relación entre las variables climatológicas y contaminantes.

**Pregunta 3:**

1. **Objetivo General:** Determinar el impacto de diferentes niveles de concentración de contaminantes atmosféricos en la calidad del aire, y en la salud humana y ambiental.
2. **Objetivos Específicos:**
  1. Indagar sobre el impacto de los contaminantes en la salud humana y ambiental, y definir rangos aceptables para cada contaminante.
  2. Comparar el impacto que tiene cada contaminante en la calidad del aire.
  3. Verificar si existen variaciones entre los niveles de contaminantes y la calidad del aire dadas por variación geográfica.
  4. Elaborar una serie de recomendaciones y medidas de prevención en base a los resultados que se obtengan.

· **Justificación de los objetivos**

La contaminación es un problema que no se puede dejar de abordar, especialmente cuando cada vez nos acercamos más al año 2030, en el cual deberíamos tener cumplidos varios ODS. En el estado de Nuevo León el principal problema de contaminación, de acuerdo a la ciudadanía, es el aire [14], por lo que resulta de interés hacer un análisis que permita encontrar información que ayude de alguna manera a disminuir este problema. A continuación se presentan las razones para la realización de este trabajo y sus objetivos:

1. **Impacto en la Salud de la Población:** La comprensión de las relaciones entre los contaminantes y la calidad del aire permitirá impactar en gran medida la salud de la población, pues podrá servir para saber hacia dónde dirigir las políticas que buscan la reducción de esta contaminación.
2. **Variabilidad climática:** El análisis de la relación entre las variables climatológicas y contaminantes, permitirá comprender cómo su relación tiene un impacto en la calidad del aire y, a su vez, en la salud humana. La comprensión de esta relación permitirá la toma de decisiones relacionadas con la prevención de problemas de salud de los ciudadanos.
3. **Evaluación e identificación de contaminantes que presentan mayor riesgo para la salud:** El conocimiento de la concentración de los contaminantes en el aire permitirá conocer el daño potencial que presentan para los habitantes del estado. Teniendo en cuenta esto, se podrá realizar la identificación de contaminantes que presenta mayor riesgo, y se podrá buscar una manera en la que se pueda mitigar la emisión de estos contaminantes.
4. **Toma de Decisiones guiada por la información obtenida:** El análisis de esta información permitirá que se puedan tomar decisiones que lleven a la mitigación del problema. Además que con estos datos se podrán planificar nuevas estrategias y políticas, generales y específicas, que permitan la prevención del aumento de la contaminación y un aumento en la afectación de la salud de los ciudadanos y del medio ambiente.

·**Descripción de las fuentes de información (datos)**

Las fuentes de información que han sido utilizadas para la realización de este trabajo hasta el momento son principalmente gubernamentales, puesto que buscamos entregar un trabajo que se sustente de fuentes que a la consideración del equipo se consideren confiables, no olvidando que se quiere primeramente tomar fuentes primarias o secundarias. Algunas de estas fuentes son la Organización Mundial de la Salud, el Servicio Nacional del Clima de Estados Unidos, las Naciones Unidas, y el gobierno de Nuevo León a través del SIMA.

Para realizar el trabajo estadístico que se presentará a continuación se hará uso de una base de datos proporcionada por el Sistema Integral de Monitoreo Ambiental de Nuevo León. Estos datos se encuentran divididos por estaciones de monitoreo, que se pueden encontrar en la página de SIMA en tiempo real. Los datos que se recopilaron son de contaminantes presentes en el aire en ciertas horas y fechas, además que son de igual manera de carácter climatológico.


· **Impacto social principal**

Se espera que el desarrollo del proyecto tenga un impacto positivo para la sociedad a través de la generación de conocimiento e información que permita la generación de planes de mitigación para el problema actual que resulta ser actualmente la contaminación del aire. Estos planes de mitigación se espera que aporten un gran beneficio a la población en general. Además de los planes de mitigación se espera que se puedan generar políticas para problemas específicos que se puedan encontrar a través de la información generada.


# Etapa II: Comprensión y preparación de los datos

Para dirigir la solución al reto, seguirás la metodología CRISP-DM. En esta primera actividad realizarás el segundo paso Comprensión y Preparación de los datos que permitirá añadir el análisis descriptivo e introductorio de las variables.

## 1) Comprensión de los datos del negocio

### Importar base de datos

```{r warning=FALSE}
sheet_names = excel_sheets("datos2022_2023_estaciones.xlsx")

for (i in 1:length(sheet_names)) {
  variable_name = paste("M",sheet_names[i],sep="_")
  value = read_excel("datos2022_2023_estaciones.xlsx",sheet = sheet_names[i])
  assign(variable_name,value) #guardamos cada hoja en una variable
}
```

Lo que se hizo en el código de arriba fue guardar los datos de cada estación en una variable. Por fines prácticos utilizaremos solamente una de ellas para realizar el análisis descriptivo de esta entrega.

### A Dimensión del dataset

```{r}
cat("Número de observaciones:",dim(M_CENTRO)[1])
cat("\nNúmero de variables:",dim(M_CENTRO)[2])
```
### Describe claramente cada una de las variables, incluyendo su nombre, descripción, tipo (categórico/Numérico) y valores posibles que puede tomar, valores nulos.

```{r}
cat("Tipo dato de cada variable\n")
t(sapply(M_CENTRO,class))
```
```{r}
summary(M_CENTRO)
```
Si observamos a simple vista la tabla hecha por la función summary(), inicialmente vemos que las variables que deberían catalogarse como cuantitativas se identifican como carateres, lo cual no resulta eficiente para hacer un analisis estadistico y descriptivo. Para solucionar esto, transformaremos los datos de las variables para que sean numéricos.

### Transformación a variables numéricas

```{r warning=FALSE}
variables_names = colnames(M_CENTRO)
M_CENTRO[,2:length(variables_names)] = sapply(M_CENTRO[,2:length(variables_names)],as.numeric)
t(sapply(M_CENTRO,class))
```
```{r}
cat("Valores únicos por cada variable\n")
for (i in 1:length(variables_names)) {
cat("\n-",variables_names[i],":",length(unique(sapply(M_CENTRO [,i],as.list)))) #Transformamos las columnas a vectores para poder calcular sus valores únicos
}
```

```{r}
cat("\nNúmero de valores nulos (NA) por variable")
for (i in 1:length(variables_names)){
  cat(cat("\n-",variables_names[i],":",length(which(is.na(M_CENTRO[,i]),arr.ind=TRUE))))
}
```


### Exploración de los datos

1. Variables cuantitativas

   - Medidas de posición no-central: cuartiles, outlier (valores atípicos), boxplots
   
```{r}

summary(M_CENTRO)
```
```{r}
#Desviacion estandar por variable
cat("Desviacion estandar por variable")
for (i in 1:length(variables_names)) {
cat(cat("\n-",variables_names[i],":",sapply(M_CENTRO[,i],var))) #omitimos los valores faltantes
}
```
Vemos que obtenemos "NA"s o "valores faltantes" cuando tratamos de obtener la desviación estándar de cada variable-a excepción de la variable de fecha ya que esa es categórica y no aporta valor al análisis. Esto se debe principalmente a que R no acepta valores faltantes al calcular la desviación estandar o la varianza por cada columna. Mucho del análisis requiere que no haya valores faltantes, por lo que tendremos que omitir estos los datos faltantes.


```{r}
#Desviacion estandar por variable
cat("Desviacion estandar por variable")
for (i in 1:length(variables_names)) {
cat(cat("\n-",variables_names[i],":",sapply(na.omit(M_CENTRO[,i]),var)))
}
```


   - Análisis de distribución de los datos (Histogramas). Identificar si tiene forma simétrica o asimétrica

```{r}
#Histograma
list <-lapply(1:ncol(M_CENTRO),
              function(col) ggplot2::qplot(M_CENTRO[[col]],
                                           geom = "histogram",
                                           binwidth = 1))

cowplot::plot_grid(plotlist = list)
```

A simple vista, podemos deducir que la mayoría de las variables cauntitativas tienen un sesgo hacia la derecha, a excepción de variables como "PRS","RH",y "TOUT".

```{r}
par(mfrow = c(2, 4)) #Despliega los boxplot en una sola hoja
for (col in variables_names) {
  boxplot(na.omit(M_CENTRO[[col]]), main = col)
}
```


   - Análisis de correlación  de los datos, mapa de calor
   
```{r}
cor_matrix = cor(na.omit(M_CENTRO[,2:length(variables_names)]))
cor_matrix
```

```{r}
# Visualiza la matriz de correlación utilizando corrplot
corrplot(cor_matrix, method = "circle")
```
Visualmente, se observan los siguientes aspectos:

* Las variables NO y NOX parecen tener una correlación positiva fuerte
* Las variables TOUT y PRS parecen tener una correlación negativa fuerte
* NO y NO2 parecen tener una correlación positiva fuerte o moderada
* La variable O3 parece ser que tiene correlaciones moderadas con NO,NO2, NOX,SR,TOUT,WSR
* La variable WSR tiene correlaciones débiles o moderadas con NO,NO2 Y NOX
* Las variables PM10 Y PM2.5 parecen tener correlaciones moderadas con NO,NO2 y NOX
* La variable RAINF no tiene ninguna relación con ninguna otra variable

Se encuentran varios patrones dentro de los datos, sin embargo, resulta central realizar pruebas de *independencia* y de *colinealidad* entre nuestras posibles variables predictoras para poder reducir la dimensionalidad de nuestra matríz de datos y la complejidad del problema. Del mismo modo, nuestras variables de interés o dependientes tendrán que ser los contaminantes que describimos en la etapa I-estos incluyen a "O3", "PM10","PM2.5" o "NO"
   
2. Variables categóricas
   - Distribución de los datos (diagramas de barras, diagramas de pastel)
   
   En este caso nadamas tenemos una variable categórica, la cual el la variable "date", por lo que no tiene mucho caso analizar esta misma

### Verificación de datos

1. Valores faltantes

Como ya se vió anteriormente, se necesitan eliminar a los valores faltantes y en el proceso de hacerlo, tenemos que asegurarnos de no haber perdido tanta información. Para esto necesitamos ver que porcentaje de los datos totales son "NA".

```{r}
cat("\nNúmero de valores nulos (NA) por variable")
props_NA = c()
for (i in 1:length(variables_names)){
  prop = length(which(is.na(M_CENTRO[,i]),arr.ind=TRUE)) / nrow(M_CENTRO)
  cat("\n-",variables_names[i],":",prop)
  props_NA[length(props_NA) + 1] = prop
}

plot(1:length(variables_names),props_NA,col="blue",xlab="Variables",ylab="Porcentaje",main="Porcentaje de Valores faltantes")
abline(h=mean(props_NA ),col="red")  #media de valores faltantes
```

Vemos que el mayor porcentaje que representan los datos faltantes es de `r mean(props_NA) * 100`%, y el máximo de ellos siendo el de la variable "PM2.5", "so2" y "NO",respectivamente. No hay un estandar que diga a que porcentaje es seguro eliminar los valores faltantes sin perder una gran cantidad de información; sin embargo, como en este caso tenemos un gran número de valores válidos con respecto a los inválidos, tomaremos la decisión empírica de eliminarlos


2. Valores de los datos

```{r}
summary(M_CENTRO)
```

## Preparación de los datos

### 1) Selección de variables predictoras

Es importante escoger las variables a utilizar para reducir la complejidad de los modelos y también para facilitar la interpretación de estos mismos. Para este caso en particular utilizaremos nos quedaremos con el siguientes listado de variables predictoras:

* PM10
* PM2.5
* N0
* N02
* N0X
* O3
* RH
* SR
* TOUT
* WSR

Las variables anteriores fueron seleccionadas en base al mapa de calor anterior donde muestra las matríz de correlaciones, y donde se visualiza la maginitud de las correlaciones.Además, se eligieron ese conjunto de contaminantes y variables metereologicas con fines de predecir los niveles de O3, PM2.5 Y PM10. No obstante, quedará pendiente realizar una prueba de independencia entre las variables.

```{r}
selected_names = c("PM10","PM2.5","SO2","O3","NO","CO","NO2","NOX","RH","SR","TOUT","WSR")

x_pred = M_CENTRO[,selected_names]
head(x_pred)
```


### 2) Transformación de datos

Descomponeremos la variable de Fecha de la matriz de datos original para crear nuevas variables categóricas que ayudarán en los modelos

```{r}
#Crear una variable de hora
hour = c()
for (i in 1:length(M_CENTRO$date)){
  parsed_timestamp = strptime(M_CENTRO$date[i],format = "%Y-%m-%d %H:%M:%S")
  hour[length(hour) + 1] = parsed_timestamp$hour #Obtenemos la hora
}

x_pred$Hour =  hour
x_pred$Hour[is.na(x_pred$Hour)] = 0 #Reemplazamos los valores NA por el cero, el ciclo no lo detecto
```


```{r}
#Crear una variable de dia
dayCounter = 1
dias = c()
for (i in 1:length(M_CENTRO$date)){
  parsed_timestamp = strptime(M_CENTRO$date[i],format = "%Y-%m-%d %H:%M:%S")
  #Reemplaazamos el valor NA por el dia correspondiente
  day = dayCounter
  dayCounter  =dayCounter + 1
  day = parsed_timestamp$mday #
  dias[length(dias) + 1] = day #dia
}

for (i in 1:length(dias)) {
if(is.na(dias[i])) {
  dias[i] =  dias[i + 1] #Reemplazamos los NA con el mes que corresponden
}  
}

x_pred$Day =  dias
```



```{r}
#Crear una variable de mes

mesCounter = 1
meses = c()
for (i in 1:length(M_CENTRO$date)){
  parsed_timestamp = strptime(M_CENTRO$date[i],format = "%Y-%m-%d %H:%M:%S")
  #Reemplaazamos el valor NA por el dia correspondiente
  mes = mesCounter
  mesCounter  =mesCounter + 1
  mes = as.numeric(format(parsed_timestamp, format = "%m"))
  meses[length(meses) + 1] = mes #mes
}

for (i in 1:length(meses)) {
if(is.na(meses[i])) {
  meses[i] =  meses[i + 1] #Reemplazamos los NA con el mes que corresponden
}  
}

x_pred$Month = meses
```


## Transformación de Datos

### Creacion de variable predictora

#### Variable objetivo o dependiente

Para el caso de variable dependiente, decidimos crear una variable categórica la cual toma en cuenta los promedios móviles ponderados  de los contaminantes PM10, PM2.5 y NO2, los cuales se clasifican en base a normas de salud establecidas internacionalmente.

![Calidad del aire]('CalidadAire.jpg')

Niveles de riesgos:

* Buena ~ 1
* Aceptable ~ 2
* Mala ~ 3
* Muy mala ~ 4
* Extremadamente Mala ~ 5


```{r}
promediosContaminantes =function(contaminantes) {
  intervalos = c(12,12,1,1,24,8,1,1,1,1,1,1)
  for (i in 1:ncol(contaminantes)) {
    contaminante = contaminantes[,i]
    intervalo = intervalos[i]
    contaminantes[,i] = rollapply(contaminante, width = intervalo, FUN = function(x) weighted.mean(x, w = seq_along(x)), align = "right", fill = NA)
  }
  
  return(contaminantes)
}

promediosTabla1 =  data.frame(PM10_12horas = x_pred$PM10,
                               PM2.5_12horas = x_pred$PM2.5,
                               O3_1hora = x_pred$O3 /1000, #Convertimos las unidades de ppb a ppm
                               NO2_1hora = x_pred$NO2 / 1000,
                               SO2_24horas = x_pred$SO2 / 1000,
                               CO_8horas = x_pred$CO,
                               NO_1hora = x_pred$NO / 1000,
                               NOX_1hora = x_pred$NOX / 1000,
                               RH_1hora = x_pred$RH,
                               SR_1hora = x_pred$SR,
                               TOUT_1hora = x_pred$TOUT,
                               WSR_1hora = x_pred$WSR
                              )

promediosTabla = promediosContaminantes(na.omit(promediosTabla1))
#promediosTabla = cbind(M_CENTRO$date, promediosTabla)
head(promediosTabla)
```
```{r}
dim(promediosTabla)
```


```{r}
#Categorizamos la calidad del aire en base a los promedios moviles ponderados de los contaminante. Se tienen que cumplir todos ellos


#calidad PM10 promedio movil ponderado de 12 horas
calidadPM10 = function(contaminante) {
  calidades = c()
  for (j in 1:length(contaminante)) {
    if (!is.na(contaminante[j]) && contaminante[j] <= 50) {
      calidades[length(calidades) + 1] = 1
    } 
    else if(!is.na(contaminante[j]) && (contaminante[j] > 50 & contaminante[j] <= 75)) {
      calidades[length(calidades) + 1] = 2
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 75 & contaminante[j] <= 155)) {
      calidades[length(calidades) + 1] = 3
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 155 & contaminante[j] <= 235)) {
      calidades[length(calidades) + 1] = 4
    }
    
    else if(!is.na(contaminante[j]) && (contaminante[j] > 236)) {
      calidades[length(calidades) + 1] = 5
    } 
    
    else if(is.na(contaminante[j])) {
      calidades[length(calidades) + 1] = 0 #inclasificable 
    }
  }
  return(calidades)
}


#Calidad PM2.5 promedio movil ponderado de 12 horas
calidadPM2.5 = function(contaminante) {
  calidades = c()
  for (j in 1:length(contaminante)) {
    if (!is.na(contaminante[j]) && contaminante[j] <= 25) {
      calidades[length(calidades) + 1] = 1
    } 
    else if(!is.na(contaminante[j]) && (contaminante[j] > 25 & contaminante[j] <= 45)) {
      calidades[length(calidades) + 1] = 2
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 45 & contaminante[j] <= 79)) {
      calidades[length(calidades) + 1] = 3
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 79 & contaminante[j] <= 147)) {
      calidades[length(calidades) + 1] = 4
    }
    
    else if(!is.na(contaminante[j]) && (contaminante[j] > 147)) {
      calidades[length(calidades) + 1] = 5
    } 
    
    else if(is.na(contaminante[j])) {
      calidades[length(calidades) + 1] = 0 #inclasificable 
    }
  }
  return(calidades)
}

#Calidad 03 1 hora
calidadO3 = function(contaminante) {
  calidades = c()
  for (j in 1:length(contaminante)) {
    if (!is.na(contaminante[j]) && contaminante[j] <= 0.051) {
      calidades[length(calidades) + 1] = 1
    } 
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.051 & contaminante[j] <= 0.095)) {
      calidades[length(calidades) + 1] = 2
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.095 & contaminante[j] <= 0.135)) {
      calidades[length(calidades) + 1] = 3
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.135 & contaminante[j] <= 0.175)) {
      calidades[length(calidades) + 1] = 4
    }
    
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.175)) {
      calidades[length(calidades) + 1] = 5
    } 
    
    else if(is.na(contaminante[j])) {
      calidades[length(calidades) + 1] = 0 #inclasificable 
    }
  }
  return(calidades)
}

#Calidad NO2 promedio de una hora
calidadNO2 = function(contaminante) {
  calidades = c()
  for (j in 1:length(contaminante)) {
    if (!is.na(contaminante[j]) && contaminante[j] <= 0.107) {
      calidades[length(calidades) + 1] = 1
    } 
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.107 & contaminante[j] <= 0.210)) {
      calidades[length(calidades) + 1] = 2
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.210 & contaminante[j] <= 0.230)) {
      calidades[length(calidades) + 1] = 3
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.230 & contaminante[j] <= 0.250)) {
      calidades[length(calidades) + 1] = 4
    }
    
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.250)) {
      calidades[length(calidades) + 1] = 5
    } 
    
    else if(is.na(contaminante[j])) {
      calidades[length(calidades) + 1] = 0 #inclasificable 
    }
  }
  return(calidades)
}

#Calidad de SO2 promedio movil de 24 horas 
calidadSO2 = function(contaminante) {
  calidades = c()
  for (j in 1:length(contaminante)) {
    if (!is.na(contaminante[j]) && contaminante[j] <= 0.008) {
      calidades[length(calidades) + 1] = 1
    } 
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.008 & contaminante[j] <= 0.110)) {
      calidades[length(calidades) + 1] = 2
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.110 & contaminante[j] <= 0.165)) {
      calidades[length(calidades) + 1] = 3
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.165 & contaminante[j] <= 0.220)) {
      calidades[length(calidades) + 1] = 4
    }
    
    else if(!is.na(contaminante[j]) && (contaminante[j] > 0.220)) {
      calidades[length(calidades) + 1] = 5
    } 
    
    else if(is.na(contaminante[j])) {
      calidades[length(calidades) + 1] = 0 #inclasificable 
    }
  }
  return(calidades)
}

#Calidad de CO promedio movil de ocho horas

calidadCO = function(contaminante) {
  calidades = c()
  for (j in 1:length(contaminante)) {
    if (!is.na(contaminante[j]) && contaminante[j] <= 8.75) {
      calidades[length(calidades) + 1] = 1
    } 
    else if(!is.na(contaminante[j]) && (contaminante[j] > 8.75 & contaminante[j] <= 11)) {
      calidades[length(calidades) + 1] = 2
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 11 & contaminante[j] <= 13.3)) {
      calidades[length(calidades) + 1] = 3
    }
    else if(!is.na(contaminante[j]) && (contaminante[j] > 13.3 & contaminante[j] <= 15.5)) {
      calidades[length(calidades) + 1] = 4
    }
    
    else if(!is.na(contaminante[j]) && (contaminante[j] > 15.5)) {
      calidades[length(calidades) + 1] = 5
    } 
    
    else if(is.na(contaminante[j])) {
      calidades[length(calidades) + 1] = 0 #inclasificable 
    }
  }
  return(calidades)
}

```

Para obtener una variable dependiente fiable que contenga la mayor cantidad de información sobre la calidad del aire, evaluamos la clasificacion de cada variable-de acuerdo a su intervalo correspondiente- y extraemos la categoria maxima (la que sea la mas contaminada). 

$y_i=max\sum_{j=1}^{m}x_j; \forall i = 1,2,3,...,n$

$m:$ Numero de variables o contaminantes
$n:$ Numero de observaciones
$x$: Clasificacion del estado del contaminante
$y$: Clasificacion final por observacion

```{r warning =FALSE}
calidadpm_2.5 = calidadPM2.5(promediosTabla$PM2.5_12horas)
calidadpm_10 = calidadPM10(promediosTabla$PM10_12horas)
calidad_O3 = calidadO3(promediosTabla$O3_1hora)
calidad_NO2  = calidadNO2(promediosTabla$NO2_1hora)
calidad_SO2 = calidadSO2(promediosTabla$SO2_24horas)
calidad_CO = calidadCO(promediosTabla$CO_8horas)

y = c() #variable predictora
for (i in 1:length(calidadpm_2.5)) {
vec_calidades = c(calidadpm_2.5[i],calidadpm_10[i],calidad_O3[i],calidad_NO2[i],calidad_SO2[i],calidad_CO[i])
y[length(y) + 1] = max(vec_calidades) 
}
```



### 3) Limpieza de datos

a) Elimina valores faltantes

```{r}
#Tratamiento de valores faltantes
x_pred = na.exclude(x_pred)
x_names = colnames(x_pred)
cat("\nNúmero de valores nulos (NA) por variable")
for (i in 1:length(x_names)){
  cat(cat("\n-",x_names[i],":",length(which(is.na(x_pred[,i]),arr.ind=TRUE))))
}
```

```{r}
#Creamos una matriz de datos completa incluyendo las variables predictoras y la dependiente ahora que eliminamos lo valores faltantes de las variables predictoras seleccionadas
X = cbind(x_pred,y)
head(X)
```


b) Elimina duplicados

```{r}
cat("Valores únicos por cada variable\n")
for (i in 1:length(selected_names)) {
cat("\n-",selected_names[i],":",length(unique(sapply(X[,i],as.list)))) #Transformamos las columnas a vectores para poder calcular sus valores únicos
}

cat("\n\nNumero de observaciones totales: ",dim(X)[1])
```

```{r}
X =  distinct(X)
cat("\n\nNumero de observaciones totales: ",dim(X)[1])
```

Parace ser que no se encontraban observaciones duplicadas 

c) Corrige valores érroneos

La correción de los errores se realizaron al principio de la etapa 2, donde originalmente el tipo de dato de las observaciones de todas las variables eran de caractér.

En base al analisis que realizamos de los valores faltantes en los puntos anteriores, vimos que no representan un porcentaje significativo en respecto con las observaciones totales, por lo que decidimos eliminarlos. Sin embargo, queda pendiente si hacer otras técnicas de sustitución de NAs mejora el rendiemiento del modelo multivariado-tal y como sustituirlos por la media de cada variable.

Por el momento, decidimos no incluir la variable de las fechas en nuestro análisis.Todavía no descartamos el potencial que pudiera representar esta variable para realizar un análisis de temporalidad o épocas del año. 



```{r}
t(sapply(X,class))
```

```{r}
head(X)
```
Asi se muestra la trabla final de la matriz de datos


b) Revisa si es necesario discretizar los datos (binning)

En este caso no haremos discretizaremos los datos, ya que no lo vemos necesario para el modelo que implementaremos.


c) Si es necesario escala y normaliza los datos.

```{r}
X$O3 = X$O3 / 1000 #ppb A ppm
X$NO2 = X$NO2 / 1000
X$SO2 = X$SO2 / 1000
X$NO = X$NO / 1000
X$NOX = X$NOX / 1000
head(X)
```

### Detección de datos atípicos

Ahora, trataremos de detectar los outliers o valores atípicos dentro de los datos de la estación central (M_CENTRO) calculando los rangos intercuartílicos (IQR) de cada variable.



# Etapa III: Adecuación y/ovalidación del Modelo

El objetivo es detectar las relaciones que se establecen en entre los contaminantes del aire y su relación con el clima en las distintas estaciones metereológicas de la Ciudad de Monterrey. Para esta etapa, realizaremos dos diferentes tipos de modelo para predecir en la calidad del aire-con la variable predictora que creamos anteriormente. La primera sera implementar una *regresión lineal multivariada* para clasificar las observaciones en su respectiva categoría. El segundo modelo será un análisis discriminante. Finalmente haremos un análisis de los residuos en cada uno de los modelos.

## Analisis por componentes principales

#### Seleccion de numeros de componentes

```{r}
#Valores y vectores propios

X_new = X[,-ncol(X)] #SELECCIONAMOS SOLAMENTE LAS VARIABLES PREDICTORAS
S = cov(X_new)

valPropios = eigen(S)$values
vecPropios =eigen(S)$vectors

cat("Valores propios\n")
print(valPropios)
cat("Vectores propios\n")
print(vecPropios)
```


```{r}
#Porcentaje de varianza explicada

propVar =   valPropios / sum(diag(S))
cat("Varianza total sumando la diagonal de S: ", sum(diag(S)))
cat("\nVarianza total de los componentes sumando los valores propios: ",sum(valPropios))
cat("\nProporcion de varianza por cada componente:\n")
print(propVar)
plot(1:length(propVar),propVar,col="red",xlab = "Numero de Componente",ylab="Proporcion de varianza explicada")
lines(1:length(propVar),propVar,col="blue")
```

```{r}
#Componentes principales: metodo 2
pca = prcomp(X_new, scale=FALSE) #escalamos los datos para que sean comparables
summary(pca)
```

Vemos que la varianza acumulada explicada por los primeros 4 componentes es de 95.077%


#### Combinacion lineal de componentes principales

```{r}
#Componentes principales: metodo
pca$x[1:10,]
```
#### Valores de las cargas


```{r}
princomp(X_new)$loadings
```
Dentro de las cargas vemos como influye cada variable en cada componente, donde tambien observamos que las variables mas influyentes dentro del primer componente son PM10, PM2.5 y RH. Para el segundo componente, las variables mas influyentes son las variables meteorologicas y PM10-PM2.5. Para el caso tres es el mismo caso que el anterior y en el componente 4 se ve que la variable del dia es muy influyente.

```{r}
resS=princomp(X_new)
compS=as.matrix(X_new)%*%resS$loadings
plot(compS[,1:2],type="p", main = "A.C.P a partir de S") #Seleccionamos los primeros dos componentes
text(compS[,1],compS[,2],1:nrow(compS), cex = 0.5, pos = 3, pch = 19, col = "red")
biplot(resS, cex = 0.5) 
```

```{r}
resS=princomp(X_new)
compS=as.matrix(X_new)%*%resS$loadings
plot(compS[,3:4],type="p", main = "A.C.P a partir de S") #Seleccionamos los componentes 3 y 4
text(compS[,3],compS[,4],1:nrow(compS), cex = 0.5, pos = 3, pch = 19, col = "red")
biplot(resS, cex = 0.5) 
```


```{r}
cp3 = PCA(X_new)
fviz_pca_ind(cp3, col.ind = "blue", addEllipses = TRUE, repel = TRUE)
fviz_screeplot(cp3)
fviz_contrib(cp3, choice = c("var"))
```


A partir del analisis por componentes principales vemos que dentro de los 4 componentes, hay 3 tipos de variables que destacan en explicar la variabilidad de la matriz de datos originales:

* PM10
* PM2.5
* RH
* Otras variables metereologicas:TOUT,WSR, etc

## Analisis Factorial

#### Esfericidad de Bartlett 

H0: Las correlaciones entre par de variables es nula.
H1: Las correlaciones entre par de variables NO es nula.
a = 0.05

p < 0.05 se rechaza H0 y sugiere que no hay correlaciones entre par de variables. 

```{r}
bartlett.test(X_new)
```
Observamos que el p-valor es muy pequeño, por lo que significa que los datos originales observables son sujetos a un analisis factorial


```{r}
#Prueba de KMO
R =  cor(X_new)
K = KMO(X_new)
K
```

El valor de KMO oscila entre 0 y 1, y una puntuación más alta indica una mejor adecuación de los datos para el análisis factorial. Lo que nos indica el resultado es que nuestras variables observables tienen un coeficiente KMO de `r K$MSA`%, lo cual se encuentra dentro de un rango mediocre según el estandar.

#### Determinar numero de factores

```{r}
scree(R)
```

Observamos que los primeros cuatro factores pasan el umbral del valor propio de 1, lo cual es un buen indicador ya que en el analisis de Componentes obtuvimos que los primeros 4 componentes explicaban alrededor del 95% de la variabilidad de los datos originales.

#### Criterio de máxima verosimilitud y el de mínimo residuo

```{r warning=FALSE}
modelo1 = principal(R, nfactors =4, rotate = "varimax")   # de máxima PCA
M1_commd = sort(modelo1$communality,decreasing = T)

plot(1:length(M1_commd),M1_commd,col="blue",ylab = "Proporcion de comm",xlab = "Variable",main="Criterio de componentes principales",xaxt = "n")
lines(1:length(M1_commd), M1_commd, col = "red", type = "l")
axis(1, at = 1:ncol(R), labels = colnames(R),las = 2) 
t(M1_commd)
```
Comparando los dos metodos para seleccionar el analisis factorial seleccionado 4 factores, observamos lo siguiente:

*Criterio de maxima verosimilitud*

Segun este criterio, las variables PM10, PM2.5, SO2 y O3 tienen un coeficiente de comunalidad cercano a 1, lo que indica que con 4 factores la informacion de estas variables practicamente no se pierde. En general vemos que los coeficientes de comunalidad de los contaminantes son altos y el de las variables meteorologicas son mas bajos.

*Criterio de mínimo residuo*

Sigue el mismo comportamiento que el criterio de minimo residuo, con la excepcion de que la comunalidad en algunas variables metereologicas son mas altas  (incluso con una diferencia de 10 puntos porcentuales).


Visualmente observamos que nos podriamos quedar con cuatro factores o componentes y conservar la variabilidad de los datos.

```{r}
rot = c("none", "varimax")
bi_mod = function(tipo){
biplot.psych(principal(X_new,nfactors = 2,rotate = tipo),main = "",col=c(2,3,4),pch = c(21,18))}
sapply(rot,bi_mod)
```

```{r}
modelo1$loadings #criterio de Componentes principales
```
```{r}
F1 =  0.673 * X_new$PM10 + 0.738 * X_new$PM2.5 + 0.485 * X_new$SO2 - 0.110 * X_new$O3  + 0.773 * X_new$NO + 0.264 * X_new$CO + 0.847 * X_new$NO2 + 0.912 * X_new$NOX - 0.104 * X_new$RH + 0.232 * X_new$SR - 0.194 * X_new$TOUT - 0.387 * X_new$WSR
```

```{r}
F2 =  0.259 * X_new$PM10 + 0.0264 * X_new$PM2.5 + 0.2098 * X_new$SO2 + 0.8622 * X_new$O3  - 0.2654 * X_new$NO - 0.0255 * X_new$CO - 0.2634 * X_new$NO2 - 0.2972 * X_new$NOX - 0.7387 * X_new$RH + 0.7032 * X_new$SR + 0.6974 * X_new$TOUT + 0.7221 * X_new$WSR + 0.5194 * X_new$Hour + 0.0292 * X_new$Day
```


```{r}
F3 =  -0.183 * X_new$PM10 - 0.028 * X_new$PM2.5 - 0.1389 * X_new$SO2 - 0.0188 * X_new$O3  + 0.1336 * X_new$NO - 0.3437 * X_new$CO - 0.1241 * X_new$NO2 + 0.0032 * X_new$NOX + 0.2687 * X_new$RH + 0.1999 * X_new$SR + 0.3286 * X_new$TOUT - 0.03798 * X_new$WSR - 0.1087 * X_new$Hour - 0.054 * X_new$Day +0.9059 *  X_new$Month
```


```{r}
F4 =  0.186 * X_new$PM10 + 0.353 * X_new$PM2.5 - 0.0635 * X_new$SO2 + 0.0584 * X_new$O3  - 0.0523 * X_new$NO + 0.58851 * X_new$CO - 0.0631 * X_new$NO2 - 0.0649* X_new$NOX + 0.2355 * X_new$RH + 0.1517 * X_new$SR + 0.2024 * X_new$TOUT - 0.02437 * X_new$WSR - 0.2305 * X_new$Hour - 0.6582 * X_new$Day - 0.0829 *  X_new$Month
```


```{r}
#Colors 

class_colors = c("green","yellow","orange","red","purple")

# Map class labels to colors
point_colors = class_colors[match(y,c(1,2,3,4,5))]


# Open a 3D plotting window
open3d()

# Create the scatter plot
plot3d(F1, F2, F3, col =point_colors ,size = 4)




# Add labels
axes3d(labels = c("X-axis", "Y-axis", "Z-axis"))
# Optionally, add a title
title3d("3D Scatter Plot")
```
```{r}
plot(F1,F2,col=point_colors,main="Clases de contaminantes descritos por F1 y F2")
# Agregar cuadricula
grid()
# Agregar leyenda
legend("topright", legend = c("Buena", "Aceptable","Mala","Muy Mala","Extremadamente Mala"), col = class_colors, lwd = 2,cex=0.7)
```


### Analisis por regresion multivariada


Podemos concluir que no es óptimo utilizar un modelo de regresión lineal múltiple, ya que, primeramente, es cuestionable debido a que las variables están auto correlacionadas y eso influye significativamente en la precisión del modelo, además que los datos no cumplen con los supuestos para utilizar un modelo de regresión lineal, como la normalidad.

### Análisis de discriminante

El modelo que utilizaremos para este modelo será mediante el análisis discriminante utilizando los primeros 4 componentes obtenidos del analisis por componentes principales anteriormente.

```{r}
# Visualiza la matriz de correlación utilizando 
X_final = cbind(X_new,y)
cor_matrix = cor(X_final)
corrplot(cor_matrix, method = "circle")
```
```{r}
cor_matrix
```


```{r}
X_final = X_final[,c("PM10","PM2.5","NOX","RH","y")]
head(X_final,10)
```

```{r}
#Asignamos un color a cada especie
lookup=c("1"='green',"2"='yellow', "3"='orange',"4" = "red",'5'='purple')

#Creamos un vector con el color corresponidente a cada observacion de acuerdo a la columna Species
col.ind=lookup[X_final$y]
#Graficos de dispersion con el color de acuerdo al tipo de especie
plot(X_final[,-ncol(X_final)][-5], pch=21, bg=col.ind, col="gray")

# Agregar cuadricula
grid()
# Agregar leyenda
legend("topright", legend = c("Buena", "Aceptable","Mala","Muy Mala","Extremadamente Mala"), col = class_colors, lwd = 2,cex=0.7)
```
Observamos que es dificil separar las clases

```{r}
head(X_final)
```


d) Determine la(s) funcion(es) lineal(es) discriminante(s) para un análisis discriminante.
  
```{r}
lda_model=lda(y~.,data=X_final)

#output
lda_model
```

Algunas de las variables predictoras tienen el mismo valor para todas las observaciones dentro de al menos una categoría de la variable y. Esto puede causar problemas en el análisis de discriminante lineal (LDA) porque no hay suficiente variabilidad en esas variables para distinguir entre los grupos. La informacion nos indica la proporcion de cada especie respecto a la variable, sus medias y la funcion discriminante. El máximo numero de funciones discriminantes útiles que pueden separar los datos es el mínimo entre $G-1$ y $p$ donde $G$ es el número de grupos (clases) y $p$ es el número de variables predictoras. En este caso será el mínimo entre 4 y 13. Por lo que el modelo ajusta a lo más 4 funciones discriminante para separar las flores por especie utilizando las 13 variables numérica.

f) Realice predicciones del modelo 
  
```{r}
predicted=predict(lda_model)


head(predicted$x)
```


g) Muestre gráficamente la segmentación de los datos. 
  
```{r}
par(mar = c(1, 1, 1, 1))  # Ajusta los márgenes izquierdo, derecho, superior e inferior
ldahist(data=predicted$x[,1],g=X_final$y, main="Histograma de la función discriminante LD1")
ldahist(data=predicted$x[,2],g=X_final$y, main="Histograma de la función discriminante LD2")
ldahist(data=predicted$x[,3],g=X_final$y, main="Histograma de la función discriminante LD2")
ldahist(data=predicted$x[,4],g=X_final$y, main="Histograma de la función discriminante LD2")
```



i) ¿El modelo es bueno para pronosticar? Indique el porcentaje de predicciones erróneas.  

```{r}
table(pred=predicted$class, true=X_final$y)

# porcentaje de observaciones clasificadas correctamente
mean(predicted$class==X$y)
```




Observamos que existe una tasa de prediccion de los valores correctos del 69.27%. Faltaría ver como sería si inyectaramos los datos de los 4 factores del analisi factorial, para mejorar el procentaje de predicción. 



## Conclusiones

**Referencias**

[1][https://www.who.int/es/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health](https://www.who.int/es/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health)

[2][https://www.weather.gov/safety/airquality](https://www.weather.gov/safety/airquality)

[3][https://www.ecologistasenaccion.org/17842/que-son-las-pm25-y-como-afectan-a-nuestra-salud/](https://www.ecologistasenaccion.org/17842/que-son-las-pm25-y-como-afectan-a-nuestra-salud/)

[4][https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics](https://www.epa.gov/ground-level-ozone-pollution/ground-level-ozone-basics)

[5][https://www.epa.gov/so2-pollution/sulfur-dioxide-basics](https://www.epa.gov/so2-pollution/sulfur-dioxide-basics)

[6][https://www.theatlantic.com/health/archive/2016/02/an-american-history-of-lead-poisoning/462576/](https://www.theatlantic.com/health/archive/2016/02/an-american-history-of-lead-poisoning/462576/)

[7][https://www.milenio.com/estados/calidad-del-aire-como-se-mide-y-que-es](https://www.milenio.com/estados/calidad-del-aire-como-se-mide-y-que-es)

[8][https://www.ecologiaverde.com/que-es-y-como-se-mide-la-calidad-del-aire-2423.html](https://www.ecologiaverde.com/que-es-y-como-se-mide-la-calidad-del-aire-2423.html)

[9][https://www.unep.org/es/noticias-y-reportajes/reportajes/como-se-mide-la-calidad-del-aire](https://www.unep.org/es/noticias-y-reportajes/reportajes/como-se-mide-la-calidad-del-aire)

[10][https://www.epa.gov/sites/default/files/2015-05/documents/aqm\_200608\_challenges.pdf](https://www.epa.gov/sites/default/files/2015-05/documents/aqm_200608_challenges.pdf)

[11][https://www.un.org/es/our-work/support-sustainable-development-and-climate-action](https://www.un.org/es/our-work/support-sustainable-development-and-climate-action)

[12][https://www.gob.mx/semarnat/acciones-y-programas/programas-de-gestion-para-mejorar-la-calidad-del-aire](https://www.gob.mx/semarnat/acciones-y-programas/programas-de-gestion-para-mejorar-la-calidad-del-aire)

[13][http://aire.nl.gob.mx/](http://aire.nl.gob.mx/)

[14] [https://consejocivico.org.mx/noticias/2023/03/23/aumenta-preocupacion-sobre-mala-calidad-del-aire-ciudadania-respalda-mayores-medidas/#:~:text=La%20contaminaci%C3%B3n%20del%20aire%20es,contaminaci%C3%B3n%20del%20agua%20(17.6%25)](https://consejocivico.org.mx/noticias/2023/03/23/aumenta-preocupacion-sobre-mala-calidad-del-aire-ciudadania-respalda-mayores-medidas/#:~:text=La%20contaminaci%C3%B3n%20del%20aire%20es,contaminaci%C3%B3n%20del%20agua%20(17.6%25)).
